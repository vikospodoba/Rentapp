<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Мой профиль - RentApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragment/header :: header}"></div>

<div class="container mt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-user-circle fa-4x text-primary"></i>
                    </div>
                    <h5 th:text="${user.fullName}">Иван Иванов</h5>
                    <p class="text-muted" th:text="${user.role}">CLIENT</p>
                    <span class="badge bg-primary" th:text="${user.role}">CLIENT</span>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <h6>Быстрый доступ</h6>
                    <ul class="nav nav-pills flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#profile-info">
                                <i class="fas fa-user me-2"></i>Профиль
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" th:href="@{/rentals}">
                                <i class="fas fa-history me-2"></i>Мои аренды
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#change-password">
                                <i class="fas fa-lock me-2"></i>Смена пароля
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Flash Messages -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Profile Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Информация профиля</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/profile/update}" th:object="${user}" method="post">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Имя</label>
                                <input type="text" class="form-control" id="firstName" th:field="*{firstName}"
                                       placeholder="Введите имя">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Фамилия</label>
                                <input type="text" class="form-control" id="lastName" th:field="*{lastName}"
                                       placeholder="Введите фамилию">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" th:field="*{email}"
                                       placeholder="Введите email" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Телефон</label>
                                <input type="tel" class="form-control" id="phone" th:field="*{phone}"
                                       placeholder="Введите номер телефона">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Имя пользователя</label>
                                <input type="text" class="form-control" th:value="${user.username}" disabled>
                                <small class="text-muted">Имя пользователя нельзя изменить</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Роль</label>
                                <input type="text" class="form-control" th:value="${user.role}" disabled>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Водительское удостоверение (только для клиентов) -->
            <div class="card mb-4" th:if="${user.role == 'CLIENT'}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-id-card me-2"></i>Водительское удостоверение</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 text-muted">
                        <span th:if="${user.driverLicenseSeries != null && user.driverLicenseNumber != null}">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            Права: <span th:text="${user.driverLicenseSeries}">00</span> <span th:text="${user.driverLicenseNumber}">000000</span>
                        </span>
                        <span th:unless="${user.driverLicenseSeries != null && user.driverLicenseNumber != null}">
                            <i class="fas fa-exclamation-circle text-warning me-1"></i>
                            Водительское удостоверение не указано.
                        </span>
                    </div>
                    <form th:action="@{/profile/driver-license}" method="post">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="driverLicenseSeries" class="form-label">Серия</label>
                                <input type="text" class="form-control" id="driverLicenseSeries" name="driverLicenseSeries"
                                       th:value="${user.driverLicenseSeries}"
                                       placeholder="0000" inputmode="numeric" maxlength="4" pattern="[0-9]{4}" required
                                       style="text-align: center; font-size: 18px; font-weight: 600; letter-spacing: 2px;">
                            </div>
                            <div class="col-md-8 mb-3">
                                <label for="driverLicenseNumber" class="form-label">Номер</label>
                                <input type="text" class="form-control" id="driverLicenseNumber" name="driverLicenseNumber"
                                       th:value="${user.driverLicenseNumber}"
                                       placeholder="000000" inputmode="numeric" maxlength="6" pattern="[0-9]{6}" required
                                       style="text-align: center; font-size: 18px; font-weight: 600; letter-spacing: 2px;">
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Сохранить права
                            </button>
                        </div>
                    </form>
                    <script>
                        // Ограничение полей только цифрами
                        document.getElementById('driverLicenseSeries')?.addEventListener('input', function(e) {
                            this.value = this.value.replace(/\D/g, '');
                        });
                        document.getElementById('driverLicenseNumber')?.addEventListener('input', function(e) {
                            this.value = this.value.replace(/\D/g, '');
                        });
                    </script>
                </div>
            </div>

            <!-- Привязанная карта (только для клиентов) -->
            <div class="card mb-4" th:if="${user.role == 'CLIENT'}">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-credit-card me-2"></i>Привязанная карта</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 text-muted">
                        <span th:if="${user.cardLast4 != null}">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            Текущая карта: **** **** **** <span th:text="${user.cardLast4}">0000</span>
                            <span th:if="${user.cardExpiry != null}">, срок действия: <span th:text="${user.cardExpiry}"></span></span>
                        </span>
                        <span th:unless="${user.cardLast4 != null}">
                            <i class="fas fa-exclamation-circle text-warning me-1"></i>
                            Карта не привязана.
                        </span>
                    </div>
                    <form th:action="@{/profile/card}" method="post" id="cardForm">
                        <div class="mb-3">
                            <label for="cardNumber" class="form-label">Номер карты</label>
                            <div class="d-flex gap-2" id="cardNumberContainer">
                                <input type="text" class="form-control card-number-input" id="cardNumber1" 
                                       maxlength="4" inputmode="numeric" pattern="[0-9]{4}" required
                                       style="text-align: center; font-size: 18px; font-weight: 600; letter-spacing: 2px;">
                                <input type="text" class="form-control card-number-input" id="cardNumber2" 
                                       maxlength="4" inputmode="numeric" pattern="[0-9]{4}" required
                                       style="text-align: center; font-size: 18px; font-weight: 600; letter-spacing: 2px;">
                                <input type="text" class="form-control card-number-input" id="cardNumber3" 
                                       maxlength="4" inputmode="numeric" pattern="[0-9]{4}" required
                                       style="text-align: center; font-size: 18px; font-weight: 600; letter-spacing: 2px;">
                                <input type="text" class="form-control card-number-input" id="cardNumber4" 
                                       maxlength="4" inputmode="numeric" pattern="[0-9]{4}" required
                                       style="text-align: center; font-size: 18px; font-weight: 600; letter-spacing: 2px;">
                            </div>
                            <input type="hidden" id="cardNumber" name="cardNumber">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cardExpiry" class="form-label">Срок действия</label>
                                <input type="text" class="form-control" id="cardExpiry" name="cardExpiry"
                                       placeholder="MM/YY" inputmode="numeric"
                                       pattern="(0[1-9]|1[0-2])/(?:[0-9]{2}|[0-9]{4})" maxlength="7" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="cardCvc" class="form-label">CVC код</label>
                                <input type="text" class="form-control" id="cardCvc" name="cardCvc"
                                       placeholder="123" inputmode="numeric"
                                       pattern="[0-9]{3}" maxlength="3" required
                                       style="text-align: center; font-size: 18px; font-weight: 600; letter-spacing: 2px;">
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-link me-2"></i>Привязать карту
                            </button>
                        </div>
                    </form>
                    <script>
                        // Автоматический переход между полями номера карты
                        document.querySelectorAll('.card-number-input').forEach((input, index, inputs) => {
                            input.addEventListener('input', function(e) {
                                this.value = this.value.replace(/\D/g, '');
                                if (this.value.length === 4 && index < inputs.length - 1) {
                                    inputs[index + 1].focus();
                                }
                            });
                            
                            input.addEventListener('keydown', function(e) {
                                if (e.key === 'Backspace' && this.value.length === 0 && index > 0) {
                                    inputs[index - 1].focus();
                                }
                            });
                        });
                        
                        // Форматирование срока действия карты
                        document.getElementById('cardExpiry')?.addEventListener('input', function(e) {
                            let value = this.value.replace(/\D/g, '');
                            if (value.length >= 2) {
                                value = value.substring(0, 2) + '/' + value.substring(2, 4);
                            }
                            this.value = value;
                        });
                        
                        // Ограничение CVC только цифрами
                        document.getElementById('cardCvc')?.addEventListener('input', function(e) {
                            this.value = this.value.replace(/\D/g, '');
                        });
                        
                        // Объединение номеров карты перед отправкой
                        document.getElementById('cardForm')?.addEventListener('submit', function(e) {
                            const cardNumber1 = document.getElementById('cardNumber1').value;
                            const cardNumber2 = document.getElementById('cardNumber2').value;
                            const cardNumber3 = document.getElementById('cardNumber3').value;
                            const cardNumber4 = document.getElementById('cardNumber4').value;
                            const fullNumber = cardNumber1 + cardNumber2 + cardNumber3 + cardNumber4;
                            document.getElementById('cardNumber').value = fullNumber;
                        });
                    </script>
                </div>
            </div>

            <!-- Change Password -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-lock me-2"></i>Смена пароля</h5>
                </div>
                <div class="card-body">
                    <form th:action="@{/profile/change-password}" method="post">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="currentPassword" class="form-label">Текущий пароль</label>
                                <input type="password" class="form-control" id="currentPassword"
                                       name="currentPassword" placeholder="Введите текущий пароль" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="newPassword" class="form-label">Новый пароль</label>
                                <input type="password" class="form-control" id="newPassword"
                                       name="newPassword" placeholder="Введите новый пароль" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="confirmPassword" class="form-label">Подтверждение пароля</label>
                                <input type="password" class="form-control" id="confirmPassword"
                                       name="confirmPassword" placeholder="Повторите новый пароль" required>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Пароль должен содержать не менее 6 символов.
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-key me-2"></i>Изменить пароль
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Недавняя активность -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Недавние аренды</h5>
                </div>
                <div class="card-body">
                    <div th:if="${#lists.isEmpty(rentals)}">
                        <p class="text-muted text-center">История аренды отсутствует.</p>
                        <div class="text-center">
                            <a th:href="@{/cars}" class="btn btn-primary">Выбрать авто</a>
                        </div>
                    </div>
                    <div th:unless="${rentals.empty}">
                        <div class="list-group">
                            <div th:each="rental : ${rentals}" class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1" th:text="${rental.car != null ? rental.car.brand + ' ' + rental.car.model : 'Автомобиль удален'}">Автомобиль</h6>
                                    <small th:classappend="${rental.status == 'COMPLETED'} ? ' text-success' :
                                                               (rental.status == 'ACTIVE' ? ' text-primary' : ' text-warning')"
                                           th:text="${rental.status}">PENDING</small>
                                </div>
                                <p class="mb-1 text-muted">
                                    <span th:text="${#temporals.format(rental.startDate, 'dd.MM.yyyy')}">01.01.2024</span>
                                    -
                                    <span th:text="${#temporals.format(rental.endDate, 'dd.MM.yyyy')}">05.01.2024</span>
                                </p>
                                <small class="text-muted">
                                    Итого: <span th:text="${rental.totalPrice != null ? #numbers.formatDecimal(rental.totalPrice, 1, 2) + ' ₽' : '—'}">180.00 ₽</span>
                                </small>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <a th:href="@{/rentals}" class="btn btn-outline-primary">Все аренды</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{fragment/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
